package com.yatsukav.msd.converter;

import org.junit.Rule;
import org.junit.Test;
import org.junit.rules.TemporaryFolder;

import java.io.BufferedReader;
import java.io.FileReader;
import java.nio.file.Paths;
import java.util.Optional;

import static org.junit.Assert.assertEquals;

public class AppTest {
    @Rule
    public TemporaryFolder folder = new TemporaryFolder();

    @Test
    public void convert2csv() throws Exception {
        String srcPath = Optional.ofNullable(getClass().getClassLoader().getResource("TRAKORW128F1484DF0.h5"))
                .orElseThrow(() -> new IllegalStateException("Internal Error: No resource for test")).getPath();
        if (srcPath.contains(":")) {
            srcPath = srcPath.substring(1);
        }

        String input = Paths.get(srcPath).getParent().toString();
        String output = folder.newFile().getAbsolutePath();
        App.convert2csv(input, output);

        StringBuilder result = new StringBuilder();
        try (BufferedReader reader = new BufferedReader(new FileReader(output))) {
            String line;
            while ((line = reader.readLine()) != null) {
                result.append(line).append("\n");
            }
        }
        assertEquals("Converting result",
                result.toString(),
                "artist_name;artist_familiarity;artist_hotness;artist_id;artist_location;artist_latitude;artist_longitude;similar_artists;artist_terms;artist_terms_freq;artist_terms_weight;artist_tags;year;release;title;song_hotness;duration;end_of_fade_in;key;key_confidence;loudness;mode;mode_confidence;start_of_fade_out;tempo;time_signature;time_signature_confidence;segments_start;segments_confidence;segments_pitches;segments_timbre;segments_loudness_max;segments_loudness_max_time;segments_loudness_start;sections_start;sections_confidence;beats_start;beats_confidence;bars_start;bars_confidence;tatums_start;tatums_confidence\n" +
                        "Janet Jackson;0.8816947313074415;0.5682014218067547;ART4QZC1187FB51612;Los Angeles &amp; New York;NaN;NaN;\"[AR5DC8S1187B9958BE, AR30R5E1187B9AD78A, AR5GRYQ1187B9B32D5, AR6B5H61187FB3BEA7, AROKXVO1187FB4D0E9, ARDNYW01187FB4D0FB, ARKSZW81187B9B695D, ARAEX7Y1187FB42D36, AR03BDP1187FB5B324, ARYXC7Z1187FB4E63A, AR5C7ZY1187FB5499F, ARZSKZU1187FB4CE1E, ARTFZOY1187FB4656A, AR0S7TA1187FB4D024, ARDUIMG1187B9B9498, ARULOIJ11F4C846658, AR22WUY1187FB414B6, ARCJMMQ1187B98D1FD, ARKWI7M1187B9B7713, ARWDO1Y1187FB380D4, ARXPPEY1187FB51DF4, AR1TIS71187FB37160, AR65K7A1187FB4DAA4, ARZ4OZG1187B9A04E8, AR52EZT1187B9900BF, AR7C6G11187B9B4C1E, ARN7POH1187B9B301E, ARPDVPJ1187B9ADBE9, ARJYQPB1187B99FB80, ARHFUOG12AF7DBA0A1, AR40VX61187FB4984D, ARP29T31187B98DD5F, ARXAWLH1187B991605, AR3MPWA1187B9A68E3, ARK9K3O1187B98F504, ARQUO3Z1187B98C912, ARRZUPG11F43A69EF7, AR8L6W21187B9AD317, ARVWU0C1187FB42F7A, AR3L9A211C8A414F25, ARRA92R1187FB3E50D, AR2SHU51187FB5CDC0, AR13ULO1187FB3F043, AR74PG51187B9AAFA0, AR93WAA1187FB42116, AR1OBVS1187B9B0A97, ARWVSYA1187B9A3104, ARKR0111187B99FD2A, ARXSH7J1187FB483BE, AR0DVRJ1187B98CBF5, ARMIMHT1187B98F038, ARBEOHF1187B9B044D, AR7BSZN1187B9B4CFB, ARX5QKE1187B9B0AD3, AR2NCM21187B991D45, ARYJSDW12454A42E5B, ARIGPNM1187B98C744, AR51JTF1187FB395B9, AR8OMD41187B9B6907, ARGEJRX12454A428AA, ARZIJSW1269FB256EF, ARWMKZU11C8A42111D, AROETUE1187FB4A677, ARJBVZM1250940EE9A, ARJXZNS12BF959F459, ARMWDRZ122C86786E6, ARS2P621187FB37B82, AR4VT3E1187FB570BB, ARHUXPN121318C57F6, ARDJKQJ12454A430F2, ARVEJYY1187FB41606, AR6001N1187B9A8632, ARZSWOV12454A38528, AR7VWZ11187B98DA42, ARP4QTX1187FB380D5, ARX00Z51187B9A5A4A, ARNUBZY1241B9CE9CF, ARUM60L1187B9A7E1F, AR8DTD41187FB51ED9, ARKU3Z61187FB51DCA, ARKNW0S1187FB3B472, ARW3LUX1187FB5C4C0, ARREJPK1187B9B1288, ARBSBET1187FB52D06, AR6681Y1187FB39B02, ARZQ7QA1187B9AD08B, ARZNA6V1187FB388B6, ARFCUN31187B9AD578, AR1WKBM1187FB38900, ARUZFLA1296AAF0B34, ARHDTNK12454A52964, ARISKUN1187FB4E2F1, ARDAF601187FB4CD05, AREMCGW121318C5844, ARMTQM21187B9AC26E, AR1F2QS1187FB374C0, ARJ3CTF1187B9A1F2E, ARXXVYZ11F50C4F556, ARPAHJC11F50C4F446, ARYLIZI1269FB32017]\";\"[dance pop, hip hop, rock, urban, pop, adult contemporary, ballad, soundtrack, disco, funk, reggae, blues, singer, sexy, female, funky, jazz, country, classic, vocal, groove, sensual, soulful, diva, black, soul, fusion]\";\"[1.0, 1.0, 1.0, 0.7005862299398349, 0.9207538113281593, 0.617160792017855, 0.4875788098665567, 0.5037608655699578, 0.4369386644987771, 0.4874877082248464, 0.38638962077270783, 0.38638962077270783, 0.20661733789104678, 0.2725764891888887, 0.3265180913360512, 0.2376027328440668, 0.38638962077270783, 0.257166381617116, 0.21846933224938855, 0.22202744546281947, 0.17487096015784334, 0.10109808745213854, 0.10109808745213854, 0.08011833875313383, 0.08011833875313383, 0.22202744546281947, 0.1516471311782078]\";\"[1.0, 0.864740011877049, 0.7785000202044913, 0.7487214637781028, 0.7486042475398536, 0.7134095081700914, 0.604223470552582, 0.5089568474162448, 0.5066891879859614, 0.4864217912866939, 0.4282509474071509, 0.418516238125027, 0.39535847728222817, 0.3949191437336349, 0.3948819056344431, 0.38623141368470254, 0.37429736868071395, 0.3489040854277292, 0.34883803975671923, 0.3486501854892344, 0.3485828756451115, 0.32708892962720815, 0.32708892962720815, 0.3113836508241132, 0.3041348001955728, 0.28819272162000414, 0.287900272540238]\";\"[pop and chart, the queen, janet-jackson]\";1993;Janet;Hold On Baby;0.25055171998902936;10.34404;0.0;10;0.007;-32.742;minor;0.318;10.344;61.878;7;0.317;\"[0.0, 0.56553, 1.58748, 2.89896, 3.13705, 3.96254, 4.46168, 4.57125, 4.90213, 6.70816]\";\"[1.0, 0.117, 0.137, 0.024, 0.017, 0.035, 0.206, 0.089, 0.027, 0.099]\";\"[0.725, 0.782, 0.779, 0.692, 0.876, 0.845, 0.63, 0.929, 1.0, 0.682, 0.839, 0.857, 0.772, 0.985, 1.0, 0.972, 0.838, 0.856, 0.879, 0.892, 0.945, 0.985, 0.769, 0.661, 0.838, 0.884, 0.685, 1.0, 0.829, 0.856, 0.745, 0.933, 0.775, 0.834, 0.868, 0.87, 0.773, 0.935, 1.0, 0.643, 0.488, 0.42, 0.656, 0.582, 0.742, 0.63, 0.814, 0.784, 0.751, 0.805, 0.685, 1.0, 0.662, 0.802, 0.845, 0.686, 0.725, 0.767, 0.586, 0.709, 1.0, 0.652, 0.77, 0.854, 0.918, 0.756, 0.714, 0.657, 0.837, 0.899, 0.774, 0.929, 0.844, 1.0, 0.538, 0.377, 0.448, 0.466, 0.518, 0.404, 0.568, 0.627, 0.628, 0.292, 0.777, 0.554, 0.692, 0.994, 1.0, 0.632, 0.742, 0.554, 0.788, 0.782, 0.627, 0.764, 0.85, 0.688, 0.829, 1.0, 0.965, 0.961, 0.819, 0.725, 0.674, 0.935, 0.819, 0.847, 0.969, 0.753, 0.808, 0.805, 0.858, 0.885, 0.79, 0.87, 1.0, 0.927, 0.962, 0.702]\";\"[18.892, 66.606, 59.975, -58.462, 11.728, 48.642, 7.595, -10.777, -2.898, 44.294, 39.09, 1.925, 22.732, 54.035, 54.481, 10.093, 0.329, -18.507, -19.107, -2.803, 10.45, 5.483, -11.917, 5.524, 22.579, 31.639, 54.127, -19.473, 4.05, -27.069, -5.28, 0.044, 7.075, 4.623, 1.7, 5.862, 22.905, 24.333, 37.452, -4.03, 9.24, -37.154, -6.893, 1.16, 5.19, 6.295, -2.396, 5.902, 23.388, 22.815, 53.805, -37.677, 3.198, -34.543, 0.009, -3.322, 1.109, 8.068, 10.744, 3.734, 25.53, 23.82, 39.116, 0.153, -0.759, -30.441, -4.72, -0.834, -8.936, -3.07, -8.117, 2.843, 24.344, 24.939, 41.946, -26.151, 2.121, -29.002, -6.309, 4.472, -3.448, 7.937, 0.878, 1.858, 25.789, 44.238, 43.633, -29.757, -4.895, -29.886, -21.879, 3.914, 3.003, 5.242, 5.523, 7.989, 25.819, 59.721, 33.17, 10.422, -13.395, -26.188, -23.286, -8.066, 9.975, 2.409, -9.76, 7.891, 20.468, 32.106, 12.461, 25.26, -8.172, -34.034, -21.647, 13.287, 5.567, -7.295, -9.296, 6.375]\";\"[-36.44, -35.191, -36.184, -35.789, -34.02, -32.965, -34.886, -33.204, -31.435, -36.435]\";\"[0.52699, 0.07937, 0.63266, 0.0268, 0.62179, 0.07846, 0.07016, 0.24201, 0.09019, 0.07905]\";\"[-60.0, -37.545, -38.89, -37.287, -38.367, -34.702, -37.909, -35.295, -33.725, -38.373]\";null\";null\";\"[0.7453, 1.71256, 2.67267, 3.6447, 4.60346, 5.58233, 6.54689]\";\"[0.749, 0.657, 0.79, 0.575, 0.628, 0.0, 0.0]\";null\";null\";\"[0.7453, 1.22893, 1.71256, 2.19619, 2.67267, 3.16107, 3.6447, 4.09971, 4.60346, 5.09766, 5.58233, 6.06699, 6.54689]\";\"[0.08, 0.067, 0.063, 0.056, 0.056, 0.061, 0.067, 0.025, 0.06, 0.059, 0.038, 0.028, 0.02]\"\n");
    }

}
